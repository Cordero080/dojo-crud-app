<!-- views/new.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('partials/head') %>
    <link rel="stylesheet" href="/css/chart.css">
    <link rel="stylesheet" href="/css/scroll.css"><!-- combobox + chart scroll styles -->
  </head>

  <%- include('partials/nav') %>

  <body class="page-new">
    <h1 class="h1-new"><%= title %></h1>

    <% if (typeof error !== 'undefined' && error) { %>
      <p class="error"><%= error %></p>
    <% } %>

    <div class="new-layout" style="margin-top: 6vh;">
      <!-- LEFT: Create Form -->
      <section class="new-left">
        <form class="page-new-form" style="margin-top: 4.2vh;" action="/forms" method="POST" autocomplete="off">
          <!-- Combobox for "Name": full syllabus + learned list (for client-side filtering) -->
          <label class="input" for="name">Choose form name:</label>
          <div
            class="combo"
            data-source='<%- JSON.stringify(availableNames || []) %>'
            data-kyu='<%- JSON.stringify(kyuRequirements || {}) %>'
            data-dan='<%- JSON.stringify(danRequirements || {}) %>'
            data-learned='<%- JSON.stringify(learnedNamesLower || []) %>'>
            <input
              id="name"
              name="name"
              required
              placeholder="Start typingâ€¦"
              value="<%= (formData && formData.name) ? formData.name : '' %>"
              aria-autocomplete="list"
              aria-controls="name-list"
              aria-expanded="false"
              role="combobox"
              autocomplete="off"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false"
              class="form-input"
            />
            <button
              type="button"
              class="combo-toggle"
              aria-label="Show options"
              aria-controls="name-list"
              aria-expanded="false">â–¾</button>
            <ul id="name-list" class="combo-list" role="listbox" hidden></ul>
          </div>
          <div id="combo-empty-note" class="muted" style="display:none;margin-top:6px;">
            All caught up â€” you are now <strong>Master Yoda</strong> ðŸ¥‹
          </div>
          <% if (errors && errors.name) { %>
            <small class="error"><%= errors.name %></small>
          <% } %>

          <!-- Rank Type -->
          <label for="rankType">Rank Type:</label>
          <select id="rankType" name="rankType" required class="form-input">
            <option value="Kyu" <%= (formData && formData.rankType === 'Kyu') ? 'selected' : '' %>>KYU</option>
            <option value="Dan" <%= (formData && formData.rankType === 'Dan') ? 'selected' : '' %>>DAN</option>
          </select>
          <% if (errors && errors.rankType) { %><small class="error"><%= errors.rankType %></small><% } %>

          <!-- Rank Number -->
          <label for="rankNumber">Rank Number:</label>
          <input
            type="number"
            id="rankNumber"
            name="rankNumber"
            min="1"
            required
            value="<%= (formData && formData.rankNumber) ? formData.rankNumber : '' %>"
            class="form-input"
          />
          <% if (errors && errors.rankNumber) { %><small class="error"><%= errors.rankNumber %></small><% } %>

          <!-- Belt Color -->
          <label for="beltColor" id="beltLabel">Belt Color</label>
          <select id="beltColor" name="beltColor" class="form-input">
            <option value="white"  <%= (formData && formData.beltColor==='white')  ? 'selected' : '' %>>White</option>
            <option value="orange" <%= (formData && formData.beltColor==='orange') ? 'selected' : '' %>>Orange</option>
            <option value="green"  <%= (formData && formData.beltColor==='green')  ? 'selected' : '' %>>Green</option>
            <option value="purple" <%= (formData && formData.beltColor==='purple') ? 'selected' : '' %>>Purple</option>
            <option value="brown"  <%= (formData && formData.beltColor==='brown')  ? 'selected' : '' %>>Brown</option>
            <option value="black"  <%= (formData && formData.beltColor==='black')  ? 'selected' : '' %>>Black</option>
          </select>

          <!-- Category (note: value MUST be "Kumite" to match schema enum) -->
          <label for="category">Category:</label>
          <select id="category" name="category" class="form-input">
            <option value="Kata"   <%= (formData && formData.category==='Kata')   ? 'selected' : '' %>>Kata</option>
            <option value="Bunkai" <%= (formData && formData.category==='Bunkai') ? 'selected' : '' %>>Bunkai</option>
            <option value="Kumite" <%= (formData && formData.category==='Kumite') ? 'selected' : '' %>>Kiso Kumite</option>
            <option value="Weapon" <%= (formData && formData.category==='Weapon') ? 'selected' : '' %>>Weapon</option>
            <option value="Other"  <%= (formData && formData.category==='Other')  ? 'selected' : '' %>>Other</option>
          </select>
          <% if (errors && errors.category) { %><small class="error"><%= errors.category %></small><% } %>

          <!-- Description -->
          <label for="description">Description:</label>
          <textarea id="description" name="description"><%= (formData && formData.description) ? formData.description : '' %></textarea>

          <!-- Reference URL -->
          <label for="referenceUrl">Reference URL:</label>
          <input
            type="url"
            id="referenceUrl"
            name="referenceUrl"
            value="<%= (formData && formData.referenceUrl) ? formData.referenceUrl : '' %>"
            class="form-input"
          />
          <% if (errors && errors.referenceUrl) { %><small class="error"><%= errors.referenceUrl %></small><% } %>

          <button type="submit" style="margin-top: 30px; margin-bottom:-16px;">Create Form</button>
        </form>
      </section>

      <!-- RIGHT: Reference (chart + requirements) -->
      <section class="new-right">
        <h2 style="text-align:center;">Rank Progression Reference</h2>
        <div id="ref-scroll" class="ref-scroll">
          <div class="chart-wrap">
            <!-- Keep bar widths; allow sideways scroll on narrow screens -->
            <div class="chart-scroll">
              <div class="chart-scroll-inner">
                <canvas
                  id="rankChart"
                  data-labels='<%- JSON.stringify(chartLabels || []) %>'
                  data-counts='<%- JSON.stringify(chartCounts || []) %>'>
                </canvas>
              </div>
            </div>
          </div>

          <div class="req-grid">
            <div>
              <h3>Kyu Requirements (Forms)</h3>
              <table class="req-table">
                <thead>
                  <tr><th>Rank</th><th>Belt</th><th>Forms</th></tr>
                </thead>
                <tbody>
                  <% Object.keys(kyuRequirements || {})
                       .sort((a,b)=>Number(b)-Number(a))
                       .forEach(n => { %>
                    <tr>
                      <td><strong>KYU <%= n %></strong></td>
                      <td><span class="belt-chip <%= (kyuChipMap || {})[n] || '' %>"></span></td>
                      <td>
                        <ul class="req-list">
                          <% (kyuRequirements[n] || []).forEach(item => { %>
                            <li><%= item %></li>
                          <% }) %>
                        </ul>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

            <div>
              <h3>Dan Requirements (Forms)</h3>
              <table class="req-table">
                <!-- Belt column shows a black chip with N gold stripes (class: dan-N) -->
                <thead><tr><th>Degree</th><th>Belt</th><th>Forms</th></tr></thead>
                <tbody>
                  <% Object.keys(danRequirements || {})
                       .sort((a,b)=>Number(a)-Number(b))
                       .forEach(n => { %>
                    <tr>
                      <td><strong>DAN <%= n %></strong></td>
                      <td>
                        <span class="belt-chip <%= (danChipMap || {})[n] || 'chip-black' %> dan-<%= n %>"></span>
                      </td>
                      <td>
                        <ul class="req-list">
                          <% (danRequirements[n] || []).forEach(item => { %>
                            <li><%= item %></li>
                          <% }) %>
                        </ul>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div style="height: 180px;"></div>
    <%- include('partials/footer') %>

    <!-- Scripts (load once, at the end) -->
    <script src="/js/main.js"></script>

    <!-- Before combobox boots: remove learned names from its data-source, and show the Yoda note if nothing remains -->
    <script>
      (function () {
        var root = document.querySelector('.combo');
        if (!root) return;
        try {
          var src = JSON.parse(root.dataset.source || "[]");
          var learned = new Set(JSON.parse(root.dataset.learned || "[]"));
          var filtered = src.filter(function(n){ return !learned.has(String(n).toLowerCase()); });
          root.dataset.source = JSON.stringify(filtered);
          if (filtered.length === 0) {
            var note = document.getElementById('combo-empty-note');
            if (note) note.style.display = 'block';
          }
        } catch (e) {
          console.warn('Combobox prefilter failed:', e);
        }
      })();
    </script>

    <script src="/js/scroll-combo.js"></script>
  </body>
</html>
